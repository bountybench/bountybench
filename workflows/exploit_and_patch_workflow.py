from pathlib import Path
from agents.executor_agent.prompt import EXPLOIT_AND_PATCH_PROMPT, STOP_TOKEN
from phases.base_phase import PhaseConfig
from phases.exploit_phase import ExploitPhase
from phases.patch_phase import PatchPhase
from resources.utils import read_exploit_report
from utils.logger import get_main_logger
from workflows.bounty_workflow import BountyWorkflow

logger = get_main_logger(__name__)

class ExploitAndPatchWorkflow(BountyWorkflow):
    """Workflow for exploiting and patching vulnerabilities"""

    def __init__(self, task_dir: Path, bounty_number: str, interactive: bool = False):
        workflow_id = "exploit_and_patch_workflow"
        super().__init__(task_dir=task_dir, 
                         bounty_number=bounty_number, 
                         workflow_id=workflow_id, 
                         interactive=interactive)     

    def _create_phases(self):
        """Define and create phases specific to ExploitAndPatchWorkflow."""

        exploit_phase = ExploitPhase(workflow=self, max_iterations=1)
        self.register_phase(exploit_phase)

        patch_phase = PatchPhase(workflow=self, max_iterations=5)
        self.register_phase(patch_phase)

    def _get_initial_prompt(self):
        """
        Provide the initial prompt for the workflow by reading the exploit report.

        Returns:
            str: The formatted initial prompt.
        """
        exploit_report = read_exploit_report(self.task_dir, self.bounty_number)
        prompt = EXPLOIT_AND_PATCH_PROMPT.format(
            task_description=exploit_report,
            stop_token=STOP_TOKEN,
            target_host=self.repo_metadata["target_host"],
        )
        return prompt

def main() -> None:
    """Main entry point"""
    import argparse
    
    parser = argparse.ArgumentParser(description="Run the exploit and patch workflow")
    parser.add_argument("--task_dir", type=str, help="The directory of the task repo")
    parser.add_argument("--bounty_number", type=str, help="The bounty number")
    parser.add_argument("--interactive", action="store_true", help="Run in interactive mode")
    args = parser.parse_args()
    
    # Create logs directory
    logs_dir = Path("logs")
    logs_dir.mkdir(exist_ok=True)
    
    # Run workflow
    workflow = ExploitAndPatchWorkflow(Path(args.task_dir), args.bounty_number, args.interactive)
    workflow.run()

if __name__ == "__main__":
    main()
